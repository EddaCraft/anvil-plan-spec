#!/usr/bin/env bash
#
# APS Install Script
# Creates APS structure in a new project with templates, skill, and commands.
#
# Usage:
#   curl -fsSL https://raw.githubusercontent.com/EddaCraft/anvil-plan-spec/main/scaffold/install | bash
#   curl ... | bash -s -- /path/to/project
#   curl ... | VERSION=0.2.0 bash
#
# For updating existing projects, use the update script instead.
#

set -euo pipefail

VERSION="${VERSION:-main}"
TARGET="${1:-.}"

# Validate TARGET to prevent path traversal
if [[ "$TARGET" == /* ]]; then
  echo "error: Absolute paths are not allowed for TARGET; please use a relative path (e.g., ./my-project)." >&2
  exit 1
fi

if [[ "$TARGET" == *".."* ]]; then
  echo "error: Parent directory references ('..') are not allowed in TARGET." >&2
  exit 1
fi

PLANS_DIR="$TARGET/plans"
BASE_URL="https://raw.githubusercontent.com/EddaCraft/anvil-plan-spec/$VERSION"

# Colors (disabled if not interactive)
if [[ -t 1 ]]; then
  GREEN='\033[0;32m'
  RED='\033[0;31m'
  BLUE='\033[0;34m'
  YELLOW='\033[1;33m'
  BOLD='\033[1m'
  NC='\033[0m'
else
  GREEN='' RED='' BLUE='' YELLOW='' BOLD='' NC=''
fi

info()  { echo -e "${GREEN}>${NC} $1"; }
warn()  { echo -e "${YELLOW}>${NC} $1"; }
error() { echo -e "${RED}error:${NC} $1"; }
step()  { echo -e "${BLUE}==>${NC} ${BOLD}$1${NC}"; }

download() {
  local path="$1"
  local dest="$2"
  local url="$BASE_URL/scaffold/$path"
  mkdir -p "$(dirname "$dest")"
  if ! curl -fsSL "$url" -o "$dest"; then
    error "Failed to download '$path' from $url"
    echo "       Please check your network connectivity and ensure VERSION='$VERSION' is correct."
    exit 1
  fi
}

# Download from repo root (for non-scaffold files like bin/ and lib/)
download_root() {
  local path="$1"
  local dest="$2"
  local url="$BASE_URL/$path"
  mkdir -p "$(dirname "$dest")"
  if ! curl -fsSL "$url" -o "$dest"; then
    error "Failed to download '$path' from $url"
    echo "       Please check your network connectivity and ensure VERSION='$VERSION' is correct."
    exit 1
  fi
}

# Prompt user with a yes/no question. Returns 0 for yes, 1 for no.
ask_yn() {
  local prompt="$1"
  local default="${2:-n}"

  if [[ -t 0 ]]; then
    local yn_hint
    if [[ "$default" == "y" ]]; then yn_hint="Y/n"; else yn_hint="y/N"; fi
    printf "%s [%s] " "$prompt" "$yn_hint"
    read -r answer
    answer="${answer:-$default}"
    [[ "$answer" =~ ^[Yy] ]]
  else
    # Non-interactive: use default
    [[ "$default" == "y" ]]
  fi
}

# Set up PATH so `aps` works without ./bin/ prefix
setup_path() {
  echo ""
  if command -v direnv &>/dev/null; then
    local envrc="$TARGET/.envrc"
    if [[ -f "$envrc" ]] && grep -q 'PATH_add bin' "$envrc" 2>/dev/null; then
      info "PATH already configured in .envrc"
    elif ask_yn "Set up direnv so you can run 'aps' without ./bin/ prefix?" "y"; then
      if [[ -f "$envrc" ]]; then
        echo 'PATH_add bin' >> "$envrc"
      else
        echo 'PATH_add bin' > "$envrc"
      fi
      info "Added 'PATH_add bin' to .envrc"
      echo "  Run 'direnv allow' to activate"
    else
      info "To run aps without the path prefix, add to your .envrc:"
      echo "  PATH_add bin"
    fi
  else
    info "To run 'aps' without ./bin/ prefix, either:"
    echo "  - Install direnv and add 'PATH_add bin' to .envrc"
    echo "  - Or add 'export PATH=\"./bin:\$PATH\"' to your shell config"
  fi
}

# Header
echo ""
echo -e "${BOLD}Anvil Plan Spec (APS)${NC}"
echo "Lightweight specs for AI-assisted development"
echo ""

# Check for existing installation
if [[ -d "$PLANS_DIR" ]]; then
  error "plans/ directory already exists at $TARGET"
  echo ""
  echo "To update templates in an existing project:"
  echo "  curl -fsSL https://raw.githubusercontent.com/EddaCraft/anvil-plan-spec/main/scaffold/update | bash"
  echo ""
  echo "To reinstall from scratch:"
  echo "  rm -rf $PLANS_DIR && curl ... | bash"
  echo ""
  exit 1
fi

# Install CLI
step "Installing APS CLI"
for f in bin/aps bin/aps.ps1 lib/output.sh lib/Output.psm1 lib/lint.sh lib/Lint.psm1 lib/scaffold.sh lib/Scaffold.psm1 lib/rules/common.sh lib/rules/Common.psm1 lib/rules/module.sh lib/rules/Module.psm1 lib/rules/index.sh lib/rules/Index.psm1 lib/rules/workitem.sh lib/rules/WorkItem.psm1 lib/rules/issues.sh lib/rules/Issues.psm1; do
  download_root "$f" "$TARGET/$f"
done
chmod +x "$TARGET/bin/aps"
info "bin/aps + lib/ (CLI)"

# Create directory structure
step "Creating directory structure"
mkdir -p "$PLANS_DIR/modules"
mkdir -p "$PLANS_DIR/execution"
mkdir -p "$PLANS_DIR/decisions"

# Download plan files
step "Downloading templates"
download "plans/aps-rules.md" "$PLANS_DIR/aps-rules.md"
info "aps-rules.md"

download "plans/index.aps.md" "$PLANS_DIR/index.aps.md"
info "index.aps.md"

download "plans/modules/.module.template.md" "$PLANS_DIR/modules/.module.template.md"
info "modules/.module.template.md"

download "plans/modules/.simple.template.md" "$PLANS_DIR/modules/.simple.template.md"
info "modules/.simple.template.md"

download "plans/modules/.index-monorepo.template.md" "$PLANS_DIR/modules/.index-monorepo.template.md"
info "modules/.index-monorepo.template.md"

download "plans/execution/.steps.template.md" "$PLANS_DIR/execution/.steps.template.md"
info "execution/.steps.template.md"

touch "$PLANS_DIR/decisions/.gitkeep"

# Install skill
step "Installing APS planning skill"

SKILL_DIR="$TARGET/aps-planning"
COMMANDS_DIR="$TARGET/.claude/commands"

mkdir -p "$SKILL_DIR/scripts"
download "aps-planning/SKILL.md" "$SKILL_DIR/SKILL.md"
download "aps-planning/reference.md" "$SKILL_DIR/reference.md"
download "aps-planning/examples.md" "$SKILL_DIR/examples.md"
download "aps-planning/hooks.md" "$SKILL_DIR/hooks.md"
download "aps-planning/scripts/install-hooks.sh" "$SKILL_DIR/scripts/install-hooks.sh"
download "aps-planning/scripts/init-session.sh" "$SKILL_DIR/scripts/init-session.sh"
download "aps-planning/scripts/check-complete.sh" "$SKILL_DIR/scripts/check-complete.sh"
download "aps-planning/scripts/pre-tool-check.sh" "$SKILL_DIR/scripts/pre-tool-check.sh"
download "aps-planning/scripts/post-tool-nudge.sh" "$SKILL_DIR/scripts/post-tool-nudge.sh"
download "aps-planning/scripts/enforce-plan-update.sh" "$SKILL_DIR/scripts/enforce-plan-update.sh"
download "aps-planning/scripts/install-hooks.ps1" "$SKILL_DIR/scripts/install-hooks.ps1"
download "aps-planning/scripts/init-session.ps1" "$SKILL_DIR/scripts/init-session.ps1"
download "aps-planning/scripts/check-complete.ps1" "$SKILL_DIR/scripts/check-complete.ps1"
download "aps-planning/scripts/pre-tool-check.ps1" "$SKILL_DIR/scripts/pre-tool-check.ps1"
download "aps-planning/scripts/post-tool-nudge.ps1" "$SKILL_DIR/scripts/post-tool-nudge.ps1"
download "aps-planning/scripts/enforce-plan-update.ps1" "$SKILL_DIR/scripts/enforce-plan-update.ps1"
chmod +x "$SKILL_DIR/scripts/"*.sh

info "aps-planning/ (skill, reference, examples, hooks, scripts)"

mkdir -p "$COMMANDS_DIR"
download "commands/plan.md" "$COMMANDS_DIR/plan.md"
download "commands/plan-status.md" "$COMMANDS_DIR/plan-status.md"

info ".claude/commands/ (plan, plan-status)"

# Success
echo ""
step "Installation complete"
echo ""
echo "  bin/"
echo "  └── aps                              <- CLI (lint, init, update)"
echo ""
echo "  plans/"
echo "  ├── aps-rules.md              # Agent guidance"
echo "  ├── index.aps.md              # Your main plan"
echo "  ├── modules/"
echo "  │   ├── .module.template.md           # Module template"
echo "  │   ├── .simple.template.md           # Simple feature template"
echo "  │   └── .index-monorepo.template.md   # Index for monorepos"
echo "  ├── execution/"
echo "  │   └── .steps.template.md    # Action steps template"
echo "  └── decisions/"
echo ""
echo "  aps-planning/"
echo "  ├── SKILL.md                  # Planning skill (core rules)"
echo "  ├── reference.md              # APS format reference"
echo "  ├── examples.md               # Real-world examples"
echo "  ├── hooks.md                  # Hook configuration guide"
echo "  └── scripts/                  # Hook install + session scripts"
echo ""
echo "  .claude/commands/"
echo "  ├── plan.md                   # /plan command"
echo "  └── plan-status.md            # /plan-status command"
echo ""

# Interactive hook prompt
if ask_yn "Install APS hooks into .claude/settings.local.json?" "y"; then
  (cd "$TARGET" && bash "$SKILL_DIR/scripts/install-hooks.sh")
else
  if ask_yn "Copy hook scripts for you to install/review later?" "y"; then
    info "Hook scripts are at: aps-planning/scripts/"
    echo "  Run ./aps-planning/scripts/install-hooks.sh when ready"
    echo "  See aps-planning/hooks.md for what each hook does"
  else
    info "Skipping hooks. You can install them later:"
    echo "  ./aps-planning/scripts/install-hooks.sh"
  fi
fi

# PATH setup
setup_path

echo ""
step "Next steps"
echo ""
echo "  1. Edit ${BOLD}plans/index.aps.md${NC} to define your plan"
echo "  2. Copy templates to create modules (remove the leading dot)"
echo "  3. Use ${BOLD}/plan${NC} in Claude Code to start planning"
echo ""
echo "Docs: https://github.com/EddaCraft/anvil-plan-spec"
echo ""
