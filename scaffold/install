#!/usr/bin/env bash
#
# APS Install Script
# Creates APS structure in a new project.
#
# Usage:
#   curl -fsSL https://raw.githubusercontent.com/EddaCraft/anvil-plan-spec/main/scaffold/install | bash
#   curl ... | bash -s -- /path/to/project
#   curl ... | VERSION=0.2.0 bash
#
# For updating existing projects, use the update script instead.
#

set -euo pipefail

VERSION="${VERSION:-main}"
TARGET="${1:-.}"

# Validate TARGET to prevent path traversal
if [[ "$TARGET" == /* ]]; then
  echo "error: Absolute paths are not allowed for TARGET; please use a relative path (e.g., ./my-project)." >&2
  exit 1
fi

if [[ "$TARGET" == *".."* ]]; then
  echo "error: Parent directory references ('..') are not allowed in TARGET." >&2
  exit 1
fi

PLANS_DIR="$TARGET/plans"
BASE_URL="https://raw.githubusercontent.com/EddaCraft/anvil-plan-spec/$VERSION"

# Colors (disabled if not interactive)
if [[ -t 1 ]]; then
  GREEN='\033[0;32m'
  RED='\033[0;31m'
  BLUE='\033[0;34m'
  BOLD='\033[1m'
  NC='\033[0m'
else
  GREEN='' RED='' BLUE='' BOLD='' NC=''
fi

info()  { echo -e "${GREEN}>${NC} $1"; }
error() { echo -e "${RED}error:${NC} $1"; }
step()  { echo -e "${BLUE}==>${NC} ${BOLD}$1${NC}"; }

download() {
  local path="$1"
  local dest="$2"
  local url="$BASE_URL/scaffold/plans/$path"
  if ! curl -fsSL "$url" -o "$dest"; then
    error "Failed to download '$path' from $url"
    echo "       Please check your network connectivity and ensure VERSION='$VERSION' is correct."
    exit 1
  fi
}

# Header
echo ""
echo -e "${BOLD}Anvil Plan Spec (APS)${NC}"
echo "Lightweight specs for AI-assisted development"
echo ""

# Check for existing installation
if [[ -d "$PLANS_DIR" ]]; then
  error "plans/ directory already exists at $TARGET"
  echo ""
  echo "To update templates in an existing project:"
  echo "  curl -fsSL https://raw.githubusercontent.com/EddaCraft/anvil-plan-spec/main/scaffold/update | bash"
  echo ""
  echo "To reinstall from scratch:"
  echo "  rm -rf $PLANS_DIR && curl ... | bash"
  echo ""
  exit 1
fi

# Create directory structure
step "Creating directory structure"
mkdir -p "$PLANS_DIR/modules"
mkdir -p "$PLANS_DIR/execution"
mkdir -p "$PLANS_DIR/decisions"

# Download files
step "Downloading templates"
download "aps-rules.md" "$PLANS_DIR/aps-rules.md"
info "aps-rules.md"

download "index.aps.md" "$PLANS_DIR/index.aps.md"
info "index.aps.md"

download "modules/.module.template.md" "$PLANS_DIR/modules/.module.template.md"
info "modules/.module.template.md"

download "modules/.simple.template.md" "$PLANS_DIR/modules/.simple.template.md"
info "modules/.simple.template.md"

download "execution/.steps.template.md" "$PLANS_DIR/execution/.steps.template.md"
info "execution/.steps.template.md"

touch "$PLANS_DIR/decisions/.gitkeep"

# Success
echo ""
step "Installation complete"
echo ""
echo "  plans/"
echo "  ├── aps-rules.md              # Agent guidance"
echo "  ├── index.aps.md              # Your main plan"
echo "  ├── modules/"
echo "  │   ├── .module.template.md   # Module template"
echo "  │   └── .simple.template.md   # Simple feature template"
echo "  ├── execution/"
echo "  │   └── .steps.template.md    # Action steps template"
echo "  └── decisions/"
echo ""
step "Next steps"
echo ""
echo "  1. Edit ${BOLD}plans/index.aps.md${NC} to define your plan"
echo "  2. Copy templates to create modules (remove the leading dot)"
echo "  3. Point your AI agent at ${BOLD}plans/aps-rules.md${NC}"
echo ""
echo "Docs: https://github.com/EddaCraft/anvil-plan-spec"
echo ""
